#!/usr/bin/env bash

# TODO: Not portable to Bourne shell.
script_dir=$(dirname "${BASH_SOURCE[0]}")

app_args=
copy_coreclr=false
copy_corefx=false
corefx_args=
loud=false
publish=false
silent=false

while getopts ':a:cf:lps' opt; do
    case "$opt" in
        a) app_args=$OPTARG ;;
        c) copy_coreclr=true ;; # TODO: Add support for passing args.
        f) copy_corefx=true; corefx_args=$OPTARG ;;
        l) loud=true ;;
        p) publish=true ;; # TODO: Add support for passing args.
        s) silent=true ;;
        \?) echo "Unknown option: -$OPTARG" >&2; exit 1 ;;
    esac

    # TODO: handle "$opt" == ":"
    # TODO: handle -- so you can write run_app -- [app args]
done

output_file=/dev/null
if "$loud"; then
    output_file=/dev/stdout
fi

error_file=/dev/stderr
if "$silent"; then
    error_file=/dev/null
fi

# Publish before copying.
if "$publish"; then
    "$script_dir/publish_app" >"$output_file" 2>"$error_file"
fi

if "$copy_coreclr"; then
    "$script_dir/copy_coreclr" -t publish >"$output_file" 2>"$error_file"
fi

if "$copy_corefx"; then
    "$script_dir/copy_corefx" -t publish $corefx_args >"$output_file" 2>"$error_file"
fi

# Run the app, which will have the same name as the dir we're in
name=$(basename "$PWD")
exec "$PWD/publish/$name" $app_args # we do not want to redirect this
